# v0.5 Detailed Implementation Plan

**Status**: Phase 1&2 Completed | Phase 3-5 Pending
**Last Updated**: 2026-02-21
**Target Release**: 2026-03
**Schema Version**: 5

---

## Table of Contents

1. [Overview](#overview)
2. [Phase Status](#phase-status)
3. [Phase 3: Template Sharing](#phase-3-template-sharing)
4. [Phase 4: Advanced Voice Commands](#phase-4-advanced-voice-commands)
5. [Phase 5: Testing & Stabilization](#phase-5-testing--stabilization)
6. [Dependencies](#dependencies)
7. [Risk Assessment](#risk-assessment)
8. [File Structure Reference](#file-structure-reference)

---

## Overview

v0.5 is the implementation release for v0.4 features. The goal is to make existing UI and type definitions actually work with real functionality.

### Completed Work (Phase 1&2)

| Component | File | Lines | Status |
|-----------|------|-------|--------|
| WASM Runtime | `plugins/runtime.rs` | 574 | ✅ Full implementation |
| WASI Host | `plugins/wasi_host.rs` | 380 | ✅ Full implementation |
| Resource Monitor | `plugins/monitor.rs` | 410 | ✅ Full implementation |
| Plugin Executor | `plugins/executor.rs` | 235+ | ✅ Integrated with WASM |
| PostgreSQL Pool | `integration/database/pool.rs` | 409+ | ✅ Async connection pool |
| MySQL Pool | `integration/database/pool.rs` | 409+ | ✅ Async connection pool |
| Git Operations | `integration/git/operations.rs` | 192+ | ✅ Commit, push, pull |
| AWS S3 Client | `integration/cloud/s3.rs` | 311+ | ✅ Upload, download, list, delete |
| Marketplace | `collaboration/marketplace.rs` | 252 | ✅ Types + handlers |
| Template I/O | `collaboration/template_io.rs` | 200 | ✅ JSON export/import with tests |
| Voice Commands | `voice/commands.rs` | 523 | ✅ Parser + Router + Conversation |

---

## Phase Status

```
Phase 1: ████████████████████ 100% (WASM Runtime)
Phase 2: ████████████████████ 100% (Integration Services)
Phase 3: ░░░░░░░░░░░░░░░░░░░░   0% (Template Sharing)
Phase 4: ░░░░░░░░░░░░░░░░░░░░   0% (Advanced Voice)
Phase 5: ░░░░░░░░░░░░░░░░░░░░   0% (Testing)
Overall:  ████░░░░░░░░░░░░░░░░  40%
```

---

## Phase 3: Template Sharing

**Duration**: 1 week
**Priority**: High
**Dependencies**: None (can start immediately)

**Note**: Backend functionality (`template_io.rs`) is already implemented with tests. This phase focuses on:
1. Tauri command integration
2. Frontend store and UI
3. Database operations

### 3.1 Backend Status (Already Implemented)

**File**: `src-tauri/src/collaboration/template_io.rs` (200 lines)

```rust
// ✅ Already implemented:
pub fn export_templates_to_json(templates: &[Template]) -> Result<Vec<u8>, String>
pub fn import_templates_from_json(
    data: &[u8],
    resolution: ConflictResolution,
) -> Result<(Vec<Template>, ImportResult), String>
pub fn export_template_to_json(template: &Template) -> Result<Vec<u8>, String>
pub fn import_template_from_json(data: &[u8]) -> Result<Template, String>
pub fn validate_template(template: &Template) -> Result<(), String>

// ✅ Tests already passing:
// - test_export_import_roundtrip
// - test_validate_template_valid
// - test_validate_template_invalid_visibility
```

**Conflict Resolution Strategies** (already implemented):
- `Skip` - Skip conflicting templates
- `Overwrite` - Replace existing templates
- `Rename` - Append suffix to ID
- `Version` - Create new version

### 3.2 Tauri Commands (Needs Implementation)

**File**: `src-tauri/src/collaboration/template_commands.rs` (new)

```rust
// Import/Export - wrap existing template_io functions
#[tauri::command]
async fn export_template(id: String) -> Result<Vec<u8>, String>

#[tauri::command]
async fn import_template(data: Vec<u8>, resolution: ConflictResolution) -> Result<Template, String>

#[tauri::command]
async fn export_all_templates() -> Result<Vec<u8>, String>

#[tauri::command]
async fn import_templates(data: Vec<u8>, resolution: ConflictResolution) -> Result<ImportResult, String>

// Versioning - needs DB integration
#[tauri::command]
async fn get_template_versions(id: String) -> Result<Vec<TemplateVersion>, String>

#[tauri::command]
async fn create_template_version(id: String, notes: String) -> Result<i64, String>

#[tauri::command]
async fn rollback_template(id: String, version_id: i64) -> Result<(), String>

// Team Sharing - needs DB integration
#[tauri::command]
async fn share_template_to_team(id: String, team_id: String, permissions: SharePermissions) -> Result<(), String>

#[tauri::command]
async fn get_team_templates(team_id: String) -> Result<Vec<Template>, String>

#[tauri::command]
async fn revoke_template_access(id: String, team_id: String) -> Result<(), String>
```

**Tasks**:
- [ ] Create `template_commands.rs` wrapping `template_io` functions
- [ ] Register commands in `lib.rs`
- [ ] Implement database operations for versioning
- [ ] Implement database operations for team sharing

### 3.2 Tauri Commands

**File**: `src-tauri/src/collaboration/template_commands.rs` (new)

```rust
// Import/Export
#[tauri::command]
async fn export_template(id: String, format: ExportFormat) -> Result<Vec<u8>, String>

#[tauri::command]
async fn import_template(data: Vec<u8>, format: ExportFormat) -> Result<Template, String>

// Marketplace
#[tauri::command]
async fn search_marketplace(query: String, filters: MarketFilters) -> Result<Vec<MarketplaceListing>, String>

#[tauri::command]
async fn download_template(id: String) -> Result<Template, String>

#[tauri::command]
async fn publish_template(id: String, options: PublishOptions) -> Result<String, String>

// Versioning
#[tauri::command]
async fn get_template_versions(id: String) -> Result<Vec<TemplateVersion>, String>

#[tauri::command]
async fn create_template_version(id: String, notes: String) -> Result<i64, String>

#[tauri::command]
async fn rollback_template(id: String, version_id: i64) -> Result<(), String>

// Team Sharing
#[tauri::command]
async fn share_template_to_team(id: String, team_id: String, permissions: SharePermissions) -> Result<(), String>

#[tauri::command]
async fn get_team_templates(team_id: String) -> Result<Vec<Template>, String>

#[tauri::command]
async fn revoke_template_access(id: String, team_id: String) -> Result<(), String>
```

**Tasks**:
- [ ] Create `template_commands.rs`
- [ ] Register commands in `lib.rs`
- [ ] Implement JSON/YAML serialization
- [ ] Add marketplace API client (mock initially)
- [ ] Implement version storage in SQLite

### 3.3 UI Components

**File**: `src/components/templates/` (new files)

| Component | File | Description |
|-----------|------|-------------|
| TemplateExportDialog | `TemplateExportDialog.tsx` | Export format selection |
| TemplateImportDialog | `TemplateImportDialog.tsx` | File import with preview |
| MarketplaceBrowser | `MarketplaceBrowser.tsx` | Browse and download templates |
| TemplateVersionHistory | `TemplateVersionHistory.tsx` | Version timeline |
| TemplateShareDialog | `TemplateShareDialog.tsx` | Team sharing options |

**Tasks**:
- [ ] Create export dialog component
- [ ] Create import dialog component
- [ ] Create marketplace browser
- [ ] Create version history view
- [ ] Create share dialog
- [ ] Add to main navigation

### 3.3 Frontend Store Implementation

**File**: `src/stores/templateStore.ts` (update existing)

**Current Status**: `collaborationStore.ts` exists but needs extension

```typescript
// Add to existing collaborationStore:
interface TemplateStore {
  // Import/Export
  exportTemplate(id: string): Promise<Blob>
  importTemplate(file: File, resolution: ConflictResolution): Promise<Template>
  exportAllTemplates(): Promise<Blob>
  importTemplates(file: File, resolution: ConflictResolution): Promise<ImportResult>

  // Versioning
  getVersionHistory(id: string): Promise<TemplateVersion[]>
  rollbackVersion(id: string, versionId: number): Promise<void>
  createVersion(id: string, notes: string): Promise<number>

  // Team Sharing
  shareToTeam(id: string, teamId: string, permissions: SharePermissions): Promise<void>
  getTeamTemplates(teamId: string): Promise<Template[]>
  revokeAccess(id: string, teamId: string): Promise<void>
}
```

**Tasks**:
- [ ] Extend existing `collaborationStore.ts`
- [ ] Add Tauri command wrappers
- [ ] Implement error handling
- [ ] Add loading states

### 3.4 UI Components

**File**: `src/components/templates/` (update existing)

| Component | File | Status | Description |
|-----------|------|--------|-------------|
| TemplateLibrary | `TemplateLibrary.tsx` | ✅ Exists | Browse local templates |
| ExportDialog | `ExportDialog.tsx` | ✅ Exists | Needs Tauri integration |
| TemplateVersionHistory | `TemplateVersionHistory.tsx` | ⏳ New | Version timeline |
| TemplateShareDialog | `TemplateShareDialog.tsx` | ⏳ New | Team sharing options |

**Tasks**:
- [ ] Connect ExportDialog to Tauri commands
- [ ] Create version history view component
- [ ] Create share dialog component
- [ ] Add import functionality to TemplateLibrary

### 3.5 Database Schema (Migration v6)

**Current Schema**: Version 5 (see `src-tauri/src/db/schema.rs`)

**New Tables** (Migration v6):

```sql
-- Template versions
CREATE TABLE IF NOT EXISTS template_versions (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    template_id TEXT NOT NULL REFERENCES templates(id) ON DELETE CASCADE,
    version INTEGER NOT NULL,
    content TEXT NOT NULL,  -- JSON serialized template
    notes TEXT,
    created_at TEXT NOT NULL DEFAULT (datetime('now')),
    UNIQUE(template_id, version)
);

-- Template sharing
CREATE TABLE IF NOT EXISTS template_shares (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    template_id TEXT NOT NULL REFERENCES templates(id) ON DELETE CASCADE,
    team_id TEXT NOT NULL,
    permissions TEXT NOT NULL,  -- JSON: {read: bool, write: bool, execute: bool}
    shared_by TEXT NOT NULL,
    shared_at TEXT NOT NULL DEFAULT (datetime('now')),
    UNIQUE(template_id, team_id)
);

-- Marketplace cache
CREATE TABLE IF NOT EXISTS marketplace_cache (
    id TEXT PRIMARY KEY,  -- marketplace template ID
    name TEXT NOT NULL,
    description TEXT,
    author TEXT,
    downloads INTEGER DEFAULT 0,
    rating REAL DEFAULT 0,
    tags TEXT,  -- JSON array
    cached_at TEXT NOT NULL DEFAULT (datetime('now'))
);

-- Indexes
CREATE INDEX IF NOT EXISTS idx_template_versions_template ON template_versions(template_id);
CREATE INDEX IF NOT EXISTS idx_template_shares_template ON template_shares(template_id);
CREATE INDEX IF NOT EXISTS idx_template_shares_team ON template_shares(team_id);
```

**Tasks**:
- [ ] Add `migrate_v6()` to `schema.rs`
- [ ] Update DB module with new query functions
- [ ] Add version CRUD operations
- [ ] Add sharing CRUD operations

### 3.6 File Ownership Map

| File/Module | Owner | Shared Files | Notes |
|-------------|-------|--------------|-------|
| `src-tauri/src/collaboration/template_commands.rs` | Worker-1 | `lib.rs`, `mod.rs` | New file |
| `src-tauri/src/db/schema.rs` (migrate_v6) | Worker-1 | `mod.rs` | Add migration |
| `src/stores/collaborationStore.ts` | Worker-2 | `types/` | Update existing |
| `src/components/templates/ExportDialog.tsx` | Worker-2 | `types/` | Update existing |
| `src/components/templates/TemplateVersionHistory.tsx` | Worker-2 | `types/` | New file |
| `src/components/templates/TemplateShareDialog.tsx` | Worker-2 | `types/` | New file |

---

## Phase 4: Advanced Voice Commands

**Duration**: 1 week
**Priority**: High
**Dependencies**: None

**Note**: Backend functionality (`commands.rs`) is already implemented with:
- VoiceCommandParser with multilingual support (English, Korean)
- VoiceRouter for skill/recipe routing
- VoiceConversationManager for multi-turn conversations
- Language detection (Hangul detection)
- 4 passing tests

### 4.1 Backend Status (Already Implemented)

**File**: `src-tauri/src/voice/commands.rs` (523 lines)

```rust
// ✅ Already implemented:
pub struct VoiceCommandParser {
    patterns: Vec<CommandPattern>,
    language_patterns: HashMap<String, Vec<CommandPattern>>,
}

impl VoiceCommandParser {
    pub fn new() -> Self  // With default EN/KO patterns
    pub fn parse(&self, transcript: &str, language: &str) -> VoiceCommand
}

pub struct VoiceRouter {
    skills: HashMap<String, SkillInfo>,
    recipes: HashMap<String, RecipeInfo>,
}

impl VoiceRouter {
    pub fn new() -> Self
    pub fn register_skill(&mut self, skill: SkillInfo)
    pub fn register_recipe(&mut self, recipe: RecipeInfo)
    pub fn route(&self, command: &VoiceCommand) -> RoutingResult
}

pub struct VoiceConversationManager {
    current_language: String,
    history: Vec<VoiceMessage>,
}

impl VoiceConversationManager {
    pub fn new() -> Self
    pub fn set_language(&mut self, language: String)
    pub fn detect_language(&self, transcript: &str) -> String  // Auto-detects KO/EN
    pub fn add_message(&mut self, role: String, content: String, language: String)
    pub fn get_history(&self) -> &[VoiceMessage]
    pub fn clear_history(&mut self)
}
```

**Supported Voice Actions**:
- `ExecuteSkill { skill_name }` - "execute {skill} skill" / "{skill} 스킬 실행"
- `RunRecipe { recipe_name }` - "run {recipe} recipe" / "{recipe} 레시피 실행"
- `SendMessage { content }` - "send {content} message" / "{content} 메시지 보내"
- `OpenFeature { feature }` - "open {feature}" / "{feature} 열기"
- `Search { query }` - "search for {query}" / "검색" patterns
- `Unknown` - No pattern matched

### 4.2 Voice Pipeline (Needs Implementation)

**File**: `src-tauri/src/voice/pipeline.rs` (new)

```rust
pub struct VoicePipeline {
    stt: SttEngine,           // From voice/stt.rs
    parser: VoiceCommandParser, // From voice/commands.rs ✅
    router: VoiceRouter,       // From voice/commands.rs ✅
    conversation: VoiceConversationManager, // From voice/commands.rs ✅
    tts: TtsEngine,           // From voice/tts.rs
    runtime: AgentRuntimeClient, // From sidecar.rs
}

impl VoicePipeline {
    pub fn new() -> Result<Self, Error>

    pub async fn process_audio(&mut self, audio: Vec<u8>) -> Result<VoiceResponse, Error> {
        // 1. STT: Audio -> Text
        let text = self.stt.transcribe(audio).await?;

        // 2. Detect language
        let language = self.conversation.detect_language(&text);

        // 3. Parse: Text -> Intent
        let command = self.parser.parse(&text, &language);

        // 4. Route: Intent -> Handler
        let routing = self.router.route(&command);

        // 5. Execute: Handler -> Result
        let result = self.execute_routing(routing).await?;

        // 6. Add to conversation
        self.conversation.add_message("user".to_string(), text, language.clone());
        self.conversation.add_message("assistant".to_string(), result.response.clone(), language);

        // 7. TTS: Result -> Audio (optional)
        let audio = self.tts.synthesize(&result.response).await?;

        Ok(VoiceResponse { audio, result, command })
    }

    pub async fn start_conversation(&mut self) -> Result<ConversationHandle, Error> {
        // Enable continuous listening mode
    }

    pub async fn stop_conversation(&mut self) -> Result<(), Error> {
        // Disable continuous listening
    }
}
```

**Tasks**:
- [ ] Create `pipeline.rs` integrating existing modules
- [ ] Implement execution routing to AgentRuntime
- [ ] Handle interruptions
- [ ] Add audio streaming support

---

## Phase 4: Advanced Voice Commands

**Duration**: 1 week
**Priority**: High
**Dependencies**: None

### 4.1 Voice Command Parser

**File**: `src-tauri/src/voice/parser.rs` (new)

```rust
pub struct VoiceCommand {
    pub intent: CommandIntent,
    pub entities: HashMap<String, String>,
    pub confidence: f32,
}

pub enum CommandIntent {
    ExecuteSkill(String),
    ExecuteRecipe(String),
    SendMessage(String),
    SwitchMode(String),
    OpenSettings(String),
    Query(String),
}

pub struct CommandParser {
    patterns: Vec<CommandPattern>,
}

impl CommandParser {
    pub fn parse(&self, transcription: &str) -> Vec<VoiceCommand> {
        // Match against patterns, return ranked commands
    }

    pub fn register_pattern(&mut self, pattern: CommandPattern) {
        // Add new command pattern
    }
}
```

**Tasks**:
- [ ] Create parser module
- [ ] Implement pattern matching
- [ ] Add confidence scoring
- [ ] Register default patterns

### 4.2 Voice Pipeline

**File**: `src-tauri/src/voice/pipeline.rs` (new)

```rust
pub struct VoicePipeline {
    stt: SttEngine,
    parser: CommandParser,
    tts: TtsEngine,
    runtime: AgentRuntimeClient,
}

impl VoicePipeline {
    pub async fn process_audio(&mut self, audio: Vec<u8>) -> Result<VoiceResponse, Error> {
        // 1. STT: Audio -> Text
        let text = self.stt.transcribe(audio).await?;

        // 2. Parse: Text -> Intent
        let command = self.parser.parse(&text)?.into_iter()
            .max_by_key(|c| c.confidence)
            .ok_or(Error::NoCommand)?;

        // 3. Execute: Intent -> Result
        let result = self.execute_command(command).await?;

        // 4. TTS: Result -> Audio
        let audio = self.tts.synthesize(&result.response).await?;

        Ok(VoiceResponse { audio, result })
    }

    pub async fn start_conversation(&mut self) -> Result<ConversationHandle, Error> {
        // Multi-turn conversation mode
    }
}
```

**Tasks**:
- [ ] Create pipeline module
- [ ] Implement multi-turn conversation
- [ ] Add conversation context tracking
- [ ] Handle interruptions

### 4.3 Command Patterns (Already Implemented)

**Default English Patterns**:
| Pattern | Action | Example |
|---------|--------|---------|
| "execute (.+) skill" | ExecuteSkill | "execute data processing skill" |
| "run (.+) recipe" | RunRecipe | "run daily backup recipe" |
| "send (.+) message" | SendMessage | "send hello world message" |
| "open (.+)" | OpenFeature | "open settings" |
| "search for (.+)" | Search | "search for weather" |

**Default Korean Patterns**:
| Pattern | Action | Example |
|---------|--------|---------|
| "(.+) 스킬 실행" | ExecuteSkill | "데이터 분석 스킬 실행" |
| "(.+) 레시피 실행" | RunRecipe | "백업 레시피 실행" |
| "(.+) 메시지 보내" | SendMessage | "안녕 메시지 보내" |
| "(.+) 열기" | OpenFeature | "설정 열기" |

**Tasks**:
- [x] Default patterns defined ✅
- [x] Multi-language support (EN/KO) ✅
- [ ] Add pattern registration API (Tauri command)
- [ ] Support custom user patterns (DB storage)

### 4.4 Frontend Integration

**File**: `src/stores/voiceStore.ts` (update existing)

**Current Status**: `voiceStore.ts` exists with STT/TTS. Needs extension.

```typescript
// Add to existing voiceStore:
interface VoiceStore {
  // Existing STT/TTS methods...
  // ✅ Already implemented:
  // initStt, voiceTranscribe, initTts, voiceSynthesize, etc.

  // New methods for voice commands:
  startConversation(): Promise<ConversationHandle>
  stopConversation(handleId: string): Promise<void>
  sendVoiceMessage(audio: Blob): Promise<VoiceResponse>
  getConversationHistory(handleId: string): Promise<VoiceMessage[]>

  // Command patterns (new)
  registerPattern(pattern: CommandPattern): Promise<void>
  getPatterns(): Promise<CommandPattern[]>
  removePattern(id: string): Promise<void>
}

interface VoiceResponse {
  audio: Blob
  text: string
  command: VoiceCommand
  result: RoutingResult
}

interface ConversationHandle {
  id: string
  isActive: boolean
  language: string
}

interface VoiceMessage {
  role: 'user' | 'assistant' | 'system'
  content: string
  language: string
  timestamp: string
}

interface CommandPattern {
  id?: string
  pattern: string
  action: string
  language: string
}
```

**Tasks**:
- [ ] Update existing `voiceStore.ts`
- [ ] Add conversation management
- [ ] Add pattern registration
- [ ] Integrate with existing STT/TTS

### 4.5 UI Components

**File**: `src/components/voice/` (update existing)

| Component | File | Status | Description |
|-----------|------|--------|-------------|
| VoiceSettings | `VoiceSettings.tsx` | ✅ Exists | STT/TTS configuration |
| VoiceButton | `VoiceButton.tsx` | ✅ Exists | Recording button |
| VoiceCommandFeedback | `VoiceCommandFeedback.tsx` | ⏳ New | Show recognized command |
| ConversationView | `ConversationView.tsx` | ⏳ New | Multi-turn conversation UI |
| PatternEditor | `PatternEditor.tsx` | ⏳ New | Custom pattern builder |
| VoiceAssistantOverlay | `VoiceAssistantOverlay.tsx` | ⏳ New | Full voice-only interface |

**Tasks**:
- [ ] Create voice command feedback display
- [ ] Create conversation view component
- [ ] Create pattern editor
- [ ] Create voice assistant overlay

### 4.6 Database Schema (Migration v6 - Extended)

**Extend Migration v6** for voice patterns:

```sql
-- Custom voice command patterns
CREATE TABLE IF NOT EXISTS voice_patterns (
    id TEXT PRIMARY KEY,
    user_id TEXT NOT NULL,
    pattern TEXT NOT NULL,
    action TEXT NOT NULL,
    language TEXT NOT NULL DEFAULT 'en',
    is_active INTEGER NOT NULL DEFAULT 1,
    created_at TEXT NOT NULL DEFAULT (datetime('now')),
    updated_at TEXT NOT NULL DEFAULT (datetime('now'))
);

-- Voice conversation history
CREATE TABLE IF NOT EXISTS voice_conversations (
    id TEXT PRIMARY KEY,
    started_at TEXT NOT NULL DEFAULT (datetime('now')),
    ended_at TEXT,
    language TEXT NOT NULL DEFAULT 'en',
    message_count INTEGER DEFAULT 0
);

-- Voice messages
CREATE TABLE IF NOT EXISTS voice_messages (
    id TEXT PRIMARY KEY,
    conversation_id TEXT NOT NULL REFERENCES voice_conversations(id) ON DELETE CASCADE,
    role TEXT NOT NULL CHECK(role IN ('user', 'assistant', 'system')),
    content TEXT NOT NULL,
    audio_data BLOB,
    language TEXT NOT NULL,
    created_at TEXT NOT NULL DEFAULT (datetime('now'))
);

-- Indexes
CREATE INDEX IF NOT EXISTS idx_voice_patterns_user ON voice_patterns(user_id);
CREATE INDEX IF NOT EXISTS idx_voice_messages_conversation ON voice_messages(conversation_id);
```

**Tasks**:
- [ ] Extend `migrate_v6()` with voice tables
- [ ] Add pattern CRUD operations
- [ ] Add conversation history operations

---

## Phase 5: Testing & Stabilization

**Duration**: 1 week
**Priority**: Critical

### 5.1 Fix Rust Warnings

**Current Status**: 207 warnings

**Categories**:

| Category | Count | Priority |
|----------|-------|----------|
| Unused functions | ~50 | Low |
| Dead code | ~30 | Medium |
| Lifetime annotations | ~20 | High |
| Missing docs | ~80 | Low |
| Clippy suggestions | ~27 | Medium |

**Tasks**:
- [ ] Run `cargo fix --lib -p ai-assistant-tauri`
- [ ] Fix lifetime syntax in `wasi_host.rs`
- [ ] Remove or mark unused code
- [ ] Add `#[allow(dead_code)]` where appropriate
- [ ] Run `cargo clippy --fix`

### 5.2 Integration Tests

**File**: `src-tauri/tests/` (new)

```rust
// Plugin WASM execution
mod plugin_tests {
    #[tokio::test]
    async fn test_wasm_plugin_execution() {}

    #[tokio::test]
    async fn test_wasi_sandbox() {}

    #[tokio::test]
    async fn test_resource_limits() {}
}

// Integration services
mod integration_tests {
    #[tokio::test]
    async fn test_postgres_query() {}

    #[tokio::test]
    async fn test_mysql_query() {}

    #[tokio::test]
    async fn test_git_operations() {}

    #[tokio::test]
    async fn test_s3_operations() {}
}

// Template sharing
mod template_tests {
    #[tokio::test]
    async fn test_template_export_import() {}

    #[tokio::test]
    async fn test_version_rollback() {}

    #[tokio::test]
    async fn test_team_sharing() {}
}

// Voice pipeline
mod voice_tests {
    #[tokio::test]
    async fn test_command_parsing() {}

    #[tokio::test]
    async fn test_voice_pipeline() {}

    #[tokio::test]
    async fn test_multi_turn_conversation() {}
}
```

**Tasks**:
- [ ] Create test directory structure
- [ ] Write plugin tests
- [ ] Write integration tests
- [ ] Write template tests
- [ ] Write voice tests
- [ ] Achieve 80% coverage

### 5.3 Performance Optimization

**Areas to Optimize**:

1. **Database Queries**
   - Add indexes for frequently queried columns
   - Implement query result caching
   - Use connection pooling efficiently

2. **WASM Execution**
   - Cache compiled WASM modules
   - Implement lazy loading for plugins
   - Add fuel limit tuning

3. **Voice Processing**
   - Implement audio streaming (avoid loading full audio)
   - Add response caching
   - Optimize TTS synthesis

4. **Frontend**
   - Implement virtual scrolling for long lists
   - Add lazy loading for components
   - Optimize bundle size

**Tasks**:
- [ ] Profile database queries
- [ ] Add caching layer
- [ ] Optimize WASM cold start
- [ ] Implement audio streaming
- [ ] Run bundle analysis

### 5.4 Security Audit

**Checklist**:

- [ ] API key encryption at rest
- [ ] Plugin permission enforcement
- [ ] SQL injection prevention
- [ ] XSS prevention in templates
- [ ] Path traversal protection
- [ ] Resource limit enforcement
- [ ] Audit logging for sensitive operations

### 5.5 Release Preparation

**Tasks**:

1. **Documentation**
   - [ ] Update README
   - [ ] Write v0.5 release notes
   - [ ] Create migration guide
   - [ ] Update API documentation

2. **Assets**
   - [ ] Update screenshots
   - [ ] Create demo video
   - [ ] Prepare changelog

3. **Build**
   - [ ] Test release build
   - [ ] Sign binaries
   - [ ] Create installer packages
   - [ ] Test upgrade from v0.4

4. **Deployment**
   - [ ] Tag release
   - [ ] Create GitHub release
   - [ ] Update marketplace listing
   - [ ] Publish announcement

---

## Dependencies

### External Dependencies (New for v0.5)

| Crate | Version | Purpose | Status |
|-------|---------|---------|--------|
| wasmtime | 22 | WASM runtime | ✅ Added |
| wasmtime-wasi | 22 | WASI sandbox | ✅ Added |
| tokio-postgres | 0.7 | PostgreSQL | ✅ Added |
| mysql_async | 0.34 | MySQL | ✅ Added |
| aws-sdk-s3 | 1 | AWS S3 | ✅ Added |
| git2 | 0.19 | Git operations | ✅ Added |
| walkdir | 2 | File traversal | ✅ Added |
| serde_yaml | 0.9 | YAML support | ⏳ Phase 3 |
| regex | 1 | Pattern matching | ⏳ Phase 4 |

### Internal Dependencies

```
Phase 3 (Templates):
  - Uses: template_io.rs (✅ exists), marketplace.rs (✅ exists)
  - Updates: collaboration/mod.rs, lib.rs

Phase 4 (Voice):
  - Uses: commands.rs (✅ exists), stt.rs, tts.rs (✅ exist)
  - Updates: voice/mod.rs, lib.rs

Phase 5 (Testing):
  - Tests all above modules
```

---

## Risk Assessment

| Risk | Probability | Impact | Mitigation |
|------|-------------|--------|------------|
| WASM compatibility issues | Medium | High | Test with popular plugins |
| Voice recognition accuracy | High | Medium | Fallback to text input |
| Database migration failures | Low | Critical | Add rollback support |
| Performance regression | Medium | Medium | Profile before/after |
| Security vulnerabilities | Low | Critical | Security audit in Phase 5 |

---

## Timeline

```
Week 1-2:  Phase 1 (WASM)        ████████████████████ DONE
Week 3-4:  Phase 2 (Integrations) ████████████████████ DONE
Week 5:    Phase 3 (Templates)    ░░░░░░░░░░░░░░░░░░░░ TODO
Week 6:    Phase 4 (Voice)        ░░░░░░░░░░░░░░░░░░░░ TODO
Week 7:    Phase 5 (Testing)      ░░░░░░░░░░░░░░░░░░░░ TODO
           ────────────────────────────────────────────────
           Total: 7 weeks | 4 weeks complete | 3 weeks remaining
```

---

## Success Criteria

### Phase 3
- [ ] Can export template to JSON/YAML
- [ ] Can import template from file
- [ ] Can browse marketplace
- [ ] Can share template to team
- [ ] Version rollback works

### Phase 4
- [ ] Voice command executes skill
- [ ] Multi-turn conversation works
- [ ] Custom patterns can be registered
- [ ] Voice-only mode functional

### Phase 5
- [ ] Zero critical warnings
- [ ] 80% test coverage
- [ ] No security vulnerabilities
- [ ] v0.4 → v0.5 upgrade tested

---

## File Structure Reference

### Rust Backend (src-tauri/src/)

```
├── collaboration/
│   ├── mod.rs              # Module exports, types (Template, SharedWorkflow, ExportOptions)
│   ├── templates.rs        # ✅ TemplateManager implementation
│   ├── export_mod.rs       # ✅ JSON/Markdown/HTML export
│   ├── template_io.rs      # ✅ JSON export/import with tests (200 lines)
│   └── marketplace.rs      # ✅ Marketplace types + handlers (252 lines)
│
├── voice/
│   ├── mod.rs              # Module exports
│   ├── stt.rs              # ✅ Speech-to-Text (Whisper)
│   ├── tts.rs              # ✅ Text-to-Speech (platform-specific)
│   └── commands.rs         # ✅ VoiceCommandParser, VoiceRouter, VoiceConversationManager (523 lines)
│
├── plugins/
│   ├── mod.rs              # Module exports, types
│   ├── loader.rs           # ✅ Plugin loading and validation
│   ├── sandbox.rs          # ✅ Sandboxed execution environment
│   ├── api.rs              # ✅ Plugin API definitions
│   ├── executor.rs         # ✅ Plugin executor with WASM integration (235+ lines)
│   ├── runtime.rs          # ✅ WASM Runtime (574 lines)
│   ├── wasi_host.rs        # ✅ WASI Host implementation (380 lines)
│   └── monitor.rs          # ✅ Resource monitoring (410 lines)
│
├── integration/
│   ├── mod.rs              # Module exports
│   ├── database/
│   │   ├── mod.rs          # Database types
│   │   └── pool.rs         # ✅ PostgreSQL/MySQL connection pools (409+ lines)
│   ├── git/
│   │   ├── mod.rs          # Git types
│   │   └── operations.rs   # ✅ Git commit, push, pull (192+ lines)
│   └── cloud/
│       ├── mod.rs          # Cloud types
│       └── s3.rs           # ✅ AWS S3 upload, download, list, delete (311+ lines)
│
├── db/
│   ├── mod.rs              # Database operations
│   └── schema.rs           # ✅ Schema migrations v1-v5
│
├── security/
│   ├── mod.rs              # Security module exports
│   ├── encryption.rs       # ✅ AES-256-GCM encryption
│   ├── credentials.rs      # ✅ Credential storage
│   └── migration.rs        # ✅ Key migration
│
├── marketplace/            # Plugin marketplace (v0.4)
│   ├── mod.rs              # Marketplace module
│   ├── listing.rs          # Listing types
│   ├── store.rs            # Store implementation
│   ├── install.rs          # Installation logic
│   └── tests.rs            # Marketplace tests
│
├── scheduler/              # Cron job scheduler (v0.3)
│   ├── mod.rs              # Scheduler exports
│   ├── cron.rs             # Cron expression parsing
│   ├── scheduler.rs        # JobScheduler implementation
│   └── runner.rs           # JobExecutor with AgentRuntime
│
├── lib.rs                  # ✅ Main Tauri commands (17K lines)
├── main.rs                 # Entry point
└── sidecar.rs              # ✅ Sidecar process management (12K lines)
```

### Frontend (src/)

```
├── components/
│   ├── voice/
│   │   ├── VoiceSettings.tsx    # ✅ STT/TTS configuration
│   │   └── VoiceButton.tsx       # ✅ Recording button
│   ├── templates/
│   │   └── TemplateLibrary.tsx   # ✅ Template browser
│   ├── settings/
│   │   └── SettingsDialog.tsx    # ✅ Multi-page settings
│   ├── plugins/
│   │   └── PluginList.tsx        # ✅ Plugin management
│   └── collaboration/
│       ├── ExportDialog.tsx      # ✅ Export options
│       └── TemplateLibrary.tsx   # ✅ Template library
│
├── stores/
│   ├── voiceStore.ts            # ✅ Voice state management
│   ├── pluginStore.ts            # ✅ Plugin state management
│   ├── collaborationStore.ts     # ✅ Template/collaboration state
│   └── integrationsStore.ts      # ✅ Integration state management
│
├── types/                       # TypeScript type definitions
├── hooks/                       # React hooks
├── services/                    # API services
├── lib/                         # Utilities
├── App.tsx                      # ✅ Main application
└── main.tsx                     # Entry point
```

### Agent Runtime (agent-runtime/src/)

```
├── index.ts                     # ✅ JSON-RPC entry point
├── agent/
│   └── core.ts                  # Agent logic
├── providers/
│   ├── base.ts                  # ✅ Provider interface
│   ├── router.ts                # ✅ Multi-LLM routing
│   ├── openai.ts                # OpenAI provider
│   ├── anthropic.ts             # Claude provider
│   └── ollama.ts                # Local LLM provider
├── mcp/
│   ├── types.ts                 # ✅ MCP protocol types
│   ├── stdio.ts                 # ✅ JSON-RPC over stdio
│   └── client.ts                # ✅ MCP client
└── memory/
    └── manager.ts               # ✅ Memory persistence
```

---

## Quick Reference

### Tauri Commands Registration Pattern

To add new commands in Phase 3/4:

1. **Create command file** (e.g., `template_commands.rs`)
2. **Register in `lib.rs`**:

```rust
// In lib.rs -> invoke_handler()
.import_template_template_command
.export_template_command
.get_template_versions_command
// ...
```

3. **Update frontend store** to call new commands via `@tauri-apps/api`

### Database Migration Pattern

To add migration v6:

1. **Add `migrate_v6()` function** to `src-tauri/src/db/schema.rs`
2. **Update version check** in `run_migrations()`
3. **Test migration** with fresh database

### Test Coverage Goals

| Module | Current Coverage | Target |
|--------|------------------|--------|
| WASM Runtime | ~20% | 80% |
| Integration Services | ~10% | 70% |
| Template I/O | ~60% ✅ | 80% |
| Voice Commands | ~40% ✅ | 80% |
| Overall | ~25% | 70% |

---

**Next Step**: Choose a phase to begin implementation.

**Last Updated**: 2026-02-21
**Document Version**: 2.0
